<!DOCTYPE html>
<html>
<head>
	<title>VIA Rail Arrivals/Departures Board</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="styles.css">
</head>
<body>

	<h1 id="stationTitle"></h1>
	<button type="button" onclick="loadDoc()">Reload times</button>
	<br /><br />
	<span>Station:</span>
	<select id="stationList">
	</select><br />
	<p style="font-style:italic;color:red;font-size:small">If a station is missing from list, there are currently no arrivals/departures on the board.</p>
	<span>Timezone:</span>
	<select id="timezone">
		<option value="America/Toronto">Eastern</option>
		<option value="America/Halifax">Atlantic</option>
		<option value="America/Winnipeg">Central</option>
		<option value="America/Regina">Saskatchewan</option>
		<option value="America/Edmonton">Mountain</option>
		<option value="America/Vancouver">Pacific</option>
	<select>
	<br /><br />
	<div id="stationBoard">
		<h2>Arrivals</h2>
		<table id="arrivals" border="1"></table>

		<h2>Departures</h2>
		<table id="departures" border="1"></table>
	
	</div>

	<script>
	var url = "stations.php";
	function loadDoc() {
	  var xhttp = new XMLHttpRequest();
	  xhttp.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
		  myFunction(this);
		}
	  };
	  xhttp.open("GET", url, true);
	  xhttp.send();
	}
	function myFunction(xml) {
	  var i;
	  var stations = [];
	  stations = [];
	  var xmlDoc = xml.responseXML;
	  var table="<tr><th>No.</th><th>Origin</th><th>Scheduled arrival</th><th>Estimated arrival</th><th>Actual arrival</th></tr>";
  	  var depTable = "<tr><th>No.</th><th>Destination</th><th>Scheduled departure</th><th>Estimated departure</th><th>Actual departure</th></tr>";
	  var x = xmlDoc.getElementsByTagName("ServiceData");
	  var timezone = document.getElementById("timezone").value;
	  var options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', timeZone: timezone, hour12: false };
	  if(document.getElementById("stationList").value.length > 0) {
		  var station = document.getElementById("stationList").value;
	  } else {
		  var station = "TORONTO";
		  document.getElementById("stationList").value = station;
	  }
	  document.getElementById("stationTitle").innerHTML = station;
	  for (i = 0; i <x.length; i++) {
		  if(stations.includes(x[i].getElementsByTagName("Station")[0].childNodes[0].nodeValue) === false) {
			stations.push(x[i].getElementsByTagName("Station")[0].childNodes[0].nodeValue);
		  }
		//console.log(i + " " + x[i].getElementsByTagName("Station")[0].childNodes[0].nodeValue);
		if( (x[i].getElementsByTagName("Station")[0].childNodes[0].nodeValue == station)
			&& (x[i].getElementsByTagName("ScheduledArrival")[0].childNodes.length > 0) ) {
			if(x[i].getElementsByTagName("EstimatedArrival")[0].childNodes.length > 0) {
				var estArr = new Date(x[i].getElementsByTagName("EstimatedArrival")[0].childNodes[0].nodeValue);
				estArr = estArr.toLocaleString('en-CA', options);
			} else {
				var estArr = "N/A";
			}
			var schedArr = new Date(x[i].getElementsByTagName("ScheduledArrival")[0].childNodes[0].nodeValue);
			if(x[i].getElementsByTagName("ActualArrival")[0].childNodes.length > 0) {
				var actArr = new Date(x[i].getElementsByTagName("ActualArrival")[0].childNodes[0].nodeValue);
				actArr = actArr.toLocaleString('en-ca', options);
			} else {
				var actArr = "N/A";
			}

			table += "<tr><td>" +
			x[i].getElementsByTagName("Train")[0].childNodes[0].nodeValue +
			"</td><td>" +
			x[i].getElementsByTagName("From")[0].childNodes[0].nodeValue +
			"</td><td>" +
				schedArr.toLocaleString('en-CA', options) +
			"</td><td>" +
				estArr +
			"</td><td>" +
				actArr +
			"</td></tr>";
		}
		if( (x[i].getElementsByTagName("Station")[0].childNodes[0].nodeValue == station)
			&& (x[i].getElementsByTagName("ScheduledDeparture")[0].childNodes.length > 0) ) {
			if(x[i].getElementsByTagName("EstimatedDeparture")[0].childNodes.length > 0) {
				var estDep = new Date(x[i].getElementsByTagName("EstimatedDeparture")[0].childNodes[0].nodeValue);
				estDep = estDep.toLocaleString('en-CA', options);
			} else {
				var estDep = "N/A";
			}
			var schedDep = new Date(x[i].getElementsByTagName("ScheduledDeparture")[0].childNodes[0].nodeValue);
			if(x[i].getElementsByTagName("ActualDeparture")[0].childNodes.length > 0) {
				var actDep = new Date(x[i].getElementsByTagName("ActualDeparture")[0].childNodes[0].nodeValue);
				actDep = actArr.toLocaleString('en-ca', options);
			} else {
				var actDep = "N/A";
			}

			depTable += "<tr><td>" +
			x[i].getElementsByTagName("Train")[0].childNodes[0].nodeValue +
			"</td><td>" +
			x[i].getElementsByTagName("To")[0].childNodes[0].nodeValue +
			"</td><td>" +
				schedDep.toLocaleString('en-CA', options) +
			"</td><td>" +
				estDep +
			"</td><td>" +
				actDep +
			"</td></tr>";


		}
	  }
	  document.getElementById("arrivals").innerHTML = table;
	  document.getElementById("departures").innerHTML = depTable;
	  stations.sort();
	  var stationList = "";
	  stations.forEach(function(e) {
		  stationList += '<option value="' + e + '">' + e + '</option>' + "\n";
	  });
	  document.getElementById("stationList").innerHTML = stationList;
	  document.getElementById("stationList").value = station;
	  sortTable("arrivals");
	  sortTable("departures");
	}


	function sortTable(tableName) {
	  var table, rows, switching, i, x, y, shouldSwitch;
	  table = document.getElementById(tableName);
	  switching = true;
	  /* Make a loop that will continue until
	  no switching has been done: */
	  while (switching) {
	    // Start by saying: no switching is done:
	    switching = false;
	    rows = table.rows;
	    /* Loop through all table rows (except the
	    first, which contains table headers): */
	    for (i = 1; i < (rows.length - 1); i++) {
	      // Start by saying there should be no switching:
	      shouldSwitch = false;
	      /* Get the two elements you want to compare,
	      one from current row and one from the next: */
	      x = rows[i].getElementsByTagName("TD")[2];
	      y = rows[i + 1].getElementsByTagName("TD")[2];
	      // Check if the two rows should switch place:
	      if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
		// If so, mark as a switch and break the loop:
		shouldSwitch = true;
		break;
	      }
	    }
	    if (shouldSwitch) {
	      /* If a switch has been marked, make the switch
	      and mark that a switch has been done: */
	      rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
	      switching = true;
	    }
	  }
	}


	window.onload = function() {
		loadDoc();
	}
	document.getElementById("stationList").onchange = function() {
		loadDoc();
	}
	document.getElementById("timezone").onchange = function() {
		loadDoc();
	}
	</script>


</body>
</html>
